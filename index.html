

html
Copy code
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator</title>
    <style>
        .calculator-container {
            max-width: 600px;
            margin: auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
        }
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    
    
  <div class="calculator-container" id="cda">
  <div class="input-group" style="display: flex; justify-content: space-between;">
    <div style="flex: 1; margin-right: 10px;">
      <label for="weight-cda">Body Weight:</label>
      <input type="number" step="any" id="weight-cda" placeholder="kg" required>
    </div>
    <div style="flex: 1;">
      <label for="bike_weight-cda">Bike Weight:</label>
      <input type="number" step="any" id="bike_weight-cda" placeholder="kg" required>
    </div>
  </div>

  <div class="input-group">
    <label for="rolling_resistance-cda">Rolling Resistance (Crr):</label>
    <select id="rolling_resistance-cda">
<option value="0.0025">Indoor Track (0.0025)</option>
<option value="0.0038">Outdoor Track (0.0038)</option>
<option value="0.0045" selected>Smooth Asphalt, Race Tyres (0.0045)</option>
<option value="0.0050">Standard Asphalt, Commuter Tyres (0.0050)</option>
<option value="0.0058">Rough Asphalt / Chip Seal (0.0058)</option>
<option value="0.0065">Packed Dirt (0.0065)</option>
<option value="0.0075">Gravel Path (0.0075)</option>
<option value="0.0080">Grass Field (0.0080)</option>
<option value="0.0105">Soft Soil / Mud (0.0105)</option>
    </select>
  </div>
  
  <div class="input-group">
    <label for="air_density-cda">Air Density (kg/m³):</label>
    <select id="air_density-cda">
      <option value="1.235">1.235 (Spring, UK)</option>
      <option value="1.215">1.215 (Summer, UK)</option>
      <option value="1.240">1.240 (Autumn, UK)</option>
      <option value="1.250">1.250 (Winter, UK)</option>
      <option value="1.225" selected>1.225 (Sea Level, 15°C)</option>
      <option value="1.184">1.184 (500m, 15°C)</option>
      <option value="1.150">1.150 (1000m, 15°C)</option>
      <option value="1.116">1.116 (1500m, 15°C)</option>
      <option value="1.082">1.082 (2000m, 15°C)</option>
    </select>
  </div>

  <div class="input-group">
    <label for="drivetrain-efficiency">Drivetrain Efficiency:</label>
    <select id="drivetrain_efficiency-cda">
<option value="0.98">New chain, ceramic bearings, large chainring/sprocket (98%)</option>
<option value="0.965">New chain, ceramic bearings, small chainring/sprocket (96.5%)</option>
<option value="0.96" selected>New chain, steel bearings, proper lubrication (96%)</option>
<option value="0.95">New chain, minimal lubrication (95%)</option>
<option value="0.94">Standard maintained chain, insufficient lubrication (94%)</option>
<option value="0.92">Old, worn chain, insufficient lubrication (92%)</option>
</select>

  </div>

 <hr class="dashed">
<div class="input-group">
  <label for="test1-name"></label>
  <input type="text" id="test1-name" placeholder="Test 1">
</div>
<div class="input-group" style="display: flex; justify-content: space-between;">
  <div style="flex: 1; margin-right: 10px;">
    <label for="power-test1">Power:</label>
    <input type="number" step="any" id="power-test1" placeholder="watts">
  </div>
  <div style="flex: 1; margin-right: 10px;">
    <label for="distance-test1">Distance:</label>
    <input type="number" step="any" id="distance-test1" placeholder="km">
  </div>
  <div style="flex: 1;">
    <label for="time-test1">Time:</label>
    <input type="text" id="time-test1" placeholder="mm:ss" pattern="([0-5]?[0-9]):([0-5][0-9])" title="Enter a valid time in the format mm:ss" required>
  </div>
</div>


  <div class="input-group" style="display: flex; justify-content: space-between;">
    <div style="flex: 1; margin-right: 10px;">
      <label for="wind_speed-test1">Wind Speed:</label>
      <input type="number" step="any" id="wind_speed-test1" placeholder="km/h" value="0" onfocus="setPlaceholder('wind_speed-test1', ' km/h')" onblur="clearPlaceholder('wind_speed-test1', ' km/h')">
    </div>
    <div style="flex: 1; margin-right: 10px;">
      <label for="yaw_angle-test1">Wind Angle:</label>
      <input type="number" step="any" id="yaw_angle-test1" placeholder="degrees" value="0" onfocus="setPlaceholder('yaw_angle-test1', ' degrees')" onblur="clearPlaceholder('yaw_angle-test1', ' degrees')">
    </div>
    <div style="flex: 1;">
      <label for="gradient-test1">Avg Grade:</label>
      <input type="number" step="any" id="gradient-test1" placeholder="%" value="0" onfocus="setPlaceholder('gradient-test1', ' %')" onblur="clearPlaceholder('gradient-test1', ' %')">
    </div>
  </div>

  <hr class="dashed">
  <div class="input-group">
    <label for="test2-name"></label>
    <input type="text" id="test2-name" placeholder="Test 2">
  </div>
<div class="input-group" style="display: flex; justify-content: space-between;">
  <div style="flex: 1; margin-right: 10px;">
    <label for="power-test2">Power:</label>
    <input type="number" step="any" id="power-test2" placeholder="watts">
  </div>
  <div style="flex: 1; margin-right: 10px;">
    <label for="distance-test2">Distance:</label>
    <input type="number" step="any" id="distance-test2" placeholder="km">
  </div>
  <div style="flex: 1;">
    <label for="time-test2">Time:</label>
    <input type="text" id="time-test2" placeholder="mm:ss" pattern="([0-5]?[0-9]):([0-5][0-9])" title="Enter a valid time in the format mm:ss" required>
  </div>
</div>

  <div class="input-group" style="display: flex; justify-content: space-between;">
    <div style="flex: 1; margin-right: 10px;">
      <label for="wind_speed-test2">Wind Speed:</label>
      <input type="number" step="any" id="wind_speed-test2" placeholder="km/h" value="0" onfocus="setPlaceholder('wind_speed-test2', ' km/h')" onblur="clearPlaceholder('wind_speed-test2', ' km/h')">
    </div>
    <div style="flex: 1; margin-right: 10px;">
      <label for="yaw_angle-test2">Wind Angle:</label>
      <input type="number" step="any" id="yaw_angle-test2" placeholder="degrees" value="0" onfocus="setPlaceholder('yaw_angle-test2', ' degrees')" onblur="clearPlaceholder('yaw_angle-test2', ' degrees')">
    </div>
    <div style="flex: 1;">
      <label for="gradient-test2">Avg Grade:</label>
      <input type="number" step="any" id="gradient-test2" placeholder="%" value="0" onfocus="setPlaceholder('gradient-test2', ' %')" onblur="clearPlaceholder('gradient-test2', ' %')">
    </div>
  </div>


  
  <hr class="dashed">
  <div class="input-group">
    <label for="test3-name"></label>
    <input type="text" id="test3-name" placeholder="Test 3">
  </div>
  <div class="input-group" style="display: flex; justify-content: space-between;">
    <div style="flex: 1; margin-right: 10px;">
      <label for="power-test3">Power:</label>
      <input type="number" step="any" id="power-test3" placeholder="watts">
    </div>
    <div style="flex: 1; margin-right: 10px;">
          <label for="distance-test3">Distance:</label>
      <input type="number" step="any" id="distance-test3" placeholder="km">
     </div>
    <div style="flex: 1;">
       <label for="time-test3">Time:</label>
      <input type="text" id="time-test3" placeholder="mm:ss" pattern="([0-5]?[0-9]):([0-5][0-9])" title="Enter a valid time in the format mm:ss" required>
  </div>
  </div>
  <div class="input-group" style="display: flex; justify-content: space-between;">
    <div style="flex: 1; margin-right: 10px;">
      <label for="wind_speed-test3">Wind Speed:</label>
      <input type="number" step="any" id="wind_speed-test3" placeholder="km/h" value="0" onfocus="setPlaceholder('wind_speed-test3', ' km/h')" onblur="clearPlaceholder('wind_speed-test3', ' km/h')">
    </div>
    <div style="flex: 1; margin-right: 10px;">
      <label for="yaw_angle-test3">Wind Angle:</label>
      <input type="number" step="any" id="yaw_angle-test3" placeholder="degrees" value="0" onfocus="setPlaceholder('yaw_angle-test3', ' degrees')" onblur="clearPlaceholder('yaw_angle-test3', ' degrees')">
    </div>
    <div style="flex: 1;">
      <label for="gradient-test3">Avg Grade:</label>
      <input type="number" step="any" id="gradient-test3" placeholder="%" value="0" onfocus="setPlaceholder('gradient-test3', ' %')" onblur="clearPlaceholder('gradient-test3', ' %')">
    </div>
  </div>

</div>

<script>
let cdaBarChart = null;
  

function setPlaceholder(inputId, placeholderText) {
    var inputElement = document.getElementById(inputId);
    if (inputElement.value == '0') {
        inputElement.placeholder = placeholderText;
        inputElement.value = '';
    }
}

function clearPlaceholder(inputId, placeholderText) {
    var inputElement = document.getElementById(inputId);
    if (inputElement.value == '') {
        inputElement.placeholder = '0' + placeholderText;
        inputElement.value = '0';
    }
}

function secondsToHMS(seconds) {
    let hours = Math.floor(seconds / 3600);
    seconds %= 3600;
    let minutes = Math.floor(seconds / 60);
    seconds = seconds % 60;
    return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toFixed(2).padStart(5, '0')}`;
}

function parseTimeToSecondsTest(timeStr) {
    if (!timeStr) return NaN;

    let parts;
    let hours = 0, minutes = 0, seconds = 0;

    if (timeStr.includes(':')) {
        parts = timeStr.split(':');

        if (parts.length === 3) {
            hours = parseInt(parts[0], 10) || 0;
            minutes = parseInt(parts[1], 10) || 0;
            seconds = parseFloat(parts[2]) || 0;
        } else if (parts.length === 2) {
            if (timeStr.indexOf(':') === 1 && parts[0].length === 1) {
                hours = parseInt(parts[0], 10) || 0;
                minutes = parseInt(parts[1], 10) || 0;
            } else {
                minutes = parseInt(parts[0], 10) || 0;
                seconds = parseFloat(parts[1]) || 0;
            }
        }
    } else if (timeStr.includes('.')) {
        parts = timeStr.split('.');
        seconds = parseInt(parts[0], 10) || 0;
        let milliseconds = parseFloat('0.' + parts[1]) || 0;
        return seconds + milliseconds;
    } else {
        seconds = parseFloat(timeStr) || 0;
    }

    return (hours * 3600) + (minutes * 60) + seconds;
}

function updatePlaceholderCda(testIndex) {
    const testDistance = parseFloat(document.getElementById(`distance-test${testIndex}`).value);
    const desiredTimeInput = document.getElementById(`time-test${testIndex}`);

    if (testDistance >= 25) {
        desiredTimeInput.placeholder = "h:mm:ss";
        desiredTimeInput.pattern = "^([0-9]?[0-9]):([0-5][0-9]):([0-5][0-9])$";
    } else if (testDistance <= 4 && testDistance > 0.5) {
        desiredTimeInput.placeholder = "mm:ss.SS";
        desiredTimeInput.pattern = "^([0-5]?[0-9]):([0-5][0-9])\\.([0-9]{1,2})$";
    } else if (testDistance <= 0.5) {
        desiredTimeInput.placeholder = "ss.SS";
        desiredTimeInput.pattern = "^([0-5]?[0-9])\\.([0-9]{1,2})$";
    } else {
        desiredTimeInput.placeholder = "mm:ss";
        desiredTimeInput.pattern = "^([0-5]?[0-9]):([0-5][0-9])$";
    }
}

function showResults() {
    document.querySelector('.results-container').classList.remove('hidden');
}

function calculateWindYawAngle(bikeSpeedMS, windSpeedMS, windAngleDegrees) {
    const windAngleRadians = windAngleDegrees * (Math.PI / 180);
    const yawAngle = Math.atan2(windSpeedMS * Math.sin(windAngleRadians), bikeSpeedMS + windSpeedMS * Math.cos(windAngleRadians));
    return yawAngle; // in radians
}

function calculatePowerSavings(cda, airDensity, speedKPH) {
    const speedMS = speedKPH / 3.6; // Convert speed from km/h to m/s
    return 0.5 * airDensity * cda * Math.pow(speedMS, 3);
}

function calculateCdA() {
    const weight = parseFloat(document.getElementById('weight-cda').value);
    const bikeWeight = parseFloat(document.getElementById('bike_weight-cda').value);
    const rollingResistance = parseFloat(document.getElementById('rolling_resistance-cda').value);
    const airDensity = parseFloat(document.getElementById('air_density-cda').value);
    const drivetrainEfficiency = parseFloat(document.getElementById('drivetrain_efficiency-cda').value);

    const tests = [
        {
            name: document.getElementById('test1-name').value || 'Test 1',
            distance: parseFloat(document.getElementById('distance-test1').value),
            time: document.getElementById('time-test1').value,
            power: parseFloat(document.getElementById('power-test1').value),
            windSpeed: parseFloat(document.getElementById('wind_speed-test1').value),
            yawAngle: parseFloat(document.getElementById('yaw_angle-test1').value),
            gradient: parseFloat(document.getElementById('gradient-test1').value) / 100,
            resultElement: document.getElementById('cdaResults-test1')
        },
        {
            name: document.getElementById('test2-name').value || 'Test 2',
            distance: parseFloat(document.getElementById('distance-test2').value),
            time: document.getElementById('time-test2').value,
            power: parseFloat(document.getElementById('power-test2').value),
            windSpeed: parseFloat(document.getElementById('wind_speed-test2').value),
            yawAngle: parseFloat(document.getElementById('yaw_angle-test2').value),
            gradient: parseFloat(document.getElementById('gradient-test2').value) / 100,
            resultElement: document.getElementById('cdaResults-test2')
        },
        {
            name: document.getElementById('test3-name').value || 'Test 3',
            distance: parseFloat(document.getElementById('distance-test3').value),
            time: document.getElementById('time-test3').value,
            power: parseFloat(document.getElementById('power-test3').value),
            windSpeed: parseFloat(document.getElementById('wind_speed-test3').value),
            yawAngle: parseFloat(document.getElementById('yaw_angle-test3').value),
            gradient: parseFloat(document.getElementById('gradient-test3').value) / 100,
            resultElement: document.getElementById('cdaResults-test3')
        }
    ];

    const totalWeight = weight + bikeWeight;
    const g = 9.80665; // Gravitational constant

    let cdaValues = [];
    let wattsPerCdaValues = [];
    let testNames = [];
    let totalPower = 0;

    for (let test of tests) {
        if (!isNaN(test.distance) && test.time && !isNaN(test.power)) {
            const timeSeconds = parseTimeToSecondsTest(test.time);
            const speedMS = (test.distance * 1000) / timeSeconds; // Convert distance from km to m
            const speedKPH = (speedMS * 3.6).toFixed(2); // Convert speed to km/h
            const windSpeedMS = test.windSpeed / 3.6; // Convert wind speed from km/h to m/s
            const yawAngleRad = calculateWindYawAngle(speedMS, windSpeedMS, test.yawAngle);

            const apparentWindSpeed = Math.sqrt(Math.pow(speedMS, 2) + Math.pow(windSpeedMS, 2) + 2 * speedMS * windSpeedMS * Math.cos(yawAngleRad));
            const effectivePower = test.power * drivetrainEfficiency; // Adjust power for drivetrain efficiency
            const rollingResistanceForce = rollingResistance * totalWeight * g;
            const rollingResistancePower = rollingResistanceForce * speedMS;
            const elevationForce = totalWeight * g * test.gradient;
            const elevationPower = elevationForce * speedMS;
            const aerodynamicPower = effectivePower - rollingResistancePower - elevationPower;

            if (aerodynamicPower < 0) {
                test.resultElement.innerHTML = `<strong>${test.name} CdA:<br></strong> Invalid Data (Negative Aerodynamic Power)`;
                continue;
            }

            const directivityFunction = Math.cos(yawAngleRad) ** 2 + 1.2 * Math.sin(yawAngleRad) ** 2;
            const cda = (2 * aerodynamicPower) / (airDensity * Math.pow(apparentWindSpeed, 3) * directivityFunction);

            cdaValues.push(cda);
            testNames.push(test.name);
            totalPower += test.power;

          const wattsPerCda = Math.round(test.power / cda);
            wattsPerCdaValues.push(wattsPerCda);

           const formattedTime = secondsToHMS(timeSeconds);

            test.resultElement.innerHTML = `
                <strong>${test.name} CdA:<br></strong> ${cda.toFixed(4)}<br>
                <strong>Speed:<br></strong> ${speedKPH} km/h<br>
                <strong>Power:<br></strong> ${test.power} W<br>
                <strong>Distance:<br></strong> ${test.distance} km<br>
                <strong>Time:<br></strong> ${formattedTime}<br>
                <strong>Watts/CdA:<br></strong> ${wattsPerCda} W/m²<br>
            `;
        } else {
            test.resultElement.innerHTML = `<strong>${test.name} CdA:<br></strong> Incomplete Data`;
        }
    }

    if (cdaValues.length > 0) {
        showResults();

        const averageCdA = cdaValues.reduce((a, b) => a + b) / cdaValues.length;
        const averagePower = totalPower / cdaValues.length;
        const averageSpeed = cdaValues.reduce((total, cda, index) => total + (tests[index].distance * 1000 / parseTimeToSecondsTest(tests[index].time)) * 3.6, 0) / cdaValues.length;
        const averageWattsPerCda = Math.round(averagePower / averageCdA);

        document.getElementById('cdaResults-average').innerHTML = `
            <strong>Average CdA:<br></strong> ${averageCdA.toFixed(4)}<br>
            <strong>Average Speed:<br></strong> ${averageSpeed.toFixed(2)} km/h<br>
            <strong>Average Power:<br></strong> ${averagePower.toFixed(2)} W<br>
            <strong>Average Watts/CdA:<br></strong> ${averageWattsPerCda} W/m²
        `;

        if (cdaValues.length > 1) {
            let differences = [];

            for (let i = 0; i < cdaValues.length; i++) {
                for (let j = i + 1; j < cdaValues.length; j++) {
                    let absoluteDiff = cdaValues[j] - cdaValues[i];
                    let percentDiff = ((cdaValues[j] - cdaValues[i]) / cdaValues[i]) * 100;
                    differences.push({ test1: tests[i].name, test2: tests[j].name, absDiff: absoluteDiff, percentDiff: percentDiff });
                }
            }

            let differenceString = differences.map(d => `${d.test1} to ${d.test2}: <br>${d.absDiff.toFixed(4)} (${d.percentDiff.toFixed(2)}%)<br>`).join('<br>');
            document.getElementById('cdaResults-difference').innerHTML = `<strong>Differences:</strong> <br>${differenceString}`;

// Calculate power savings at 35 km/h, 45 km/h, and 55 km/h
const speeds = [35, 45, 55];
let powerSavingsHTML = '<strong>Power Savings:</strong><br>';

for (let i = 0; i < speeds.length; i++) {
    powerSavingsHTML += `<strong>At ${speeds[i]} km/h:</strong><br>`;
    for (let j = 0; j < cdaValues.length - 1; j++) {
        for (let k = j + 1; k < cdaValues.length; k++) {
            const power1 = Math.round(calculatePowerSavings(cdaValues[j], airDensity, speeds[i]));
            const power2 = Math.round(calculatePowerSavings(cdaValues[k], airDensity, speeds[i]));
            const powerSaved = Math.round(power1 - power2);

            powerSavingsHTML += `${tests[j].name} to ${tests[k].name}: ${powerSaved} W<br>`;
        }
    }
}

            document.getElementById('cdaResults-power-savings').innerHTML = powerSavingsHTML;
        } else {
            document.getElementById('cdaResults-difference').innerHTML = `<strong>Differences:</strong> N/A`;
            document.getElementById('cdaResults-power-savings').innerHTML = ''; // Clear power savings if less than 2 tests
        }

        document.dispatchEvent(new CustomEvent('cdaCalculated', {
            detail: {
                testNames,
                cdaValues,
                averageCdA,
                weight,
                bikeWeight
            }
        }));

        // Ensure these elements exist if needed
        if (document.getElementById('weight-race')) {
            document.getElementById('weight-race').value = weight;
        }
        if (document.getElementById('bike-weight-race')) {
            document.getElementById('bike-weight-race').value = bikeWeight;
        }
        if (document.getElementById('cda-test1')) {
            document.getElementById('cda-test1').value = cdaValues[0]?.toFixed(4) || '';
        }
        if (document.getElementById('cda-test2')) {
            document.getElementById('cda-test2').value = cdaValues[1]?.toFixed(4) || '';
        }
        if (document.getElementById('cda-test3')) {
            document.getElementById('cda-test3').value = cdaValues[2]?.toFixed(4) || '';
        }
        if (document.getElementById('cda-average')) {
            document.getElementById('cda-average').value = averageCdA.toFixed(4);
        }
        if (document.getElementById('weight-ps')) {
            document.getElementById('weight-ps').value = weight;
        }
        if (document.getElementById('bike-weight-ps')) {
            document.getElementById('bike-weight-ps').value = bikeWeight;
        }
        if (document.getElementById('cda-ps-test1')) {
            document.getElementById('cda-ps-test1').value = cdaValues[0]?.toFixed(4) || '';
        }
        if (document.getElementById('cda-ps-test2')) {
            document.getElementById('cda-ps-test2').value = cdaValues[1]?.toFixed(4) || '';
        }
        if (document.getElementById('cda-ps-test3')) {
            document.getElementById('cda-ps-test3').value = cdaValues[2]?.toFixed(4) || '';
        }

        // Call the graph update function if it exists
        if (typeof updateGraph === 'function') {
            updateGraph(testNames, cdaValues, averageCdA, wattsPerCdaValues);
        }
    }
}

document.querySelectorAll('#weight-cda, #bike_weight-cda, #rolling_resistance-cda, #air_density-cda, #drivetrain_efficiency-cda, #distance-test1, #time-test1, #power-test1, #wind_speed-test1, #yaw_angle-test1, #gradient-test1, #distance-test2, #time-test2, #power-test2, #wind_speed-test2, #yaw_angle-test2, #gradient-test2, #distance-test3, #time-test3, #power-test3, #wind_speed-test3, #yaw_angle-test3, #gradient-test3').forEach(element => {
    element.addEventListener('input', calculateCdA);
    element.addEventListener('change', calculateCdA);
});

document.getElementById('distance-test1').addEventListener('input', () => updatePlaceholderCda(1));
document.getElementById('distance-test2').addEventListener('input', () => updatePlaceholderCda(2));
document.getElementById('distance-test3').addEventListener('input', () => updatePlaceholderCda(3));
</script>

<div class="calculator-container">
  <div class="zones">
    <label>CdA Results:</label>
    <div class="results-container hidden">
      <div class="result">
        <div id="cdaResults-test1" class="result-column"></div>
        <div id="cdaResults-test2" class="result-column"></div>
        <div id="cdaResults-test3" class="result-column"></div>
      </div>
      <div class="result">
        <div id="cdaResults-average" class="result-column"></div>
        <div id="cdaResults-difference" class="result-column"></div>
      </div>
      <div class="result">
        <canvas id="cdaBarChart" height="400" class="result-column" style="width: 100%;"></canvas>
      </div>
      <div class="result">
        <div id="cdaResults-power-savings" class="result-column"></div>
      </div>
    </div>
  </div>
</div>

<script>
function updateGraph(testNames, cdaValues, averageCdA, wattsPerCdaValues) {
    const ctx = document.getElementById('cdaBarChart').getContext('2d');

    const barColors = [
        'rgba(75, 192, 192, 0.6)',
        'rgba(255, 99, 132, 0.6)',
        'rgba(54, 162, 235, 0.6)',
        'rgba(255, 206, 86, 0.6)',
        'rgba(153, 102, 255, 0.6)',
        'rgba(255, 159, 64, 0.6)',
        'rgba(199, 199, 199, 0.6)',
        'rgba(83, 102, 255, 0.6)',
        'rgba(99, 255, 132, 0.6)',
        'rgba(235, 54, 162, 0.6)',
        'rgba(206, 255, 86, 0.6)',
        'rgba(102, 153, 255, 0.6)',
        'rgba(159, 64, 255, 0.6)',
        'rgba(255, 199, 199, 0.6)',
        'rgba(192, 75, 75, 0.6)'
    ];

    if (cdaBarChart) {
        cdaBarChart.data.labels = testNames;
        cdaBarChart.data.datasets[0].data = cdaValues;
        cdaBarChart.data.datasets[0].backgroundColor = barColors.slice(0, cdaValues.length);
        cdaBarChart.data.datasets[1].data = new Array(cdaValues.length).fill(averageCdA);
        cdaBarChart.data.datasets[2].data = wattsPerCdaValues;
        cdaBarChart.update();
    } else {
        cdaBarChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: testNames, // Set the labels to the test names
                datasets: [
                    {
                        label: 'CdA Values',
                        data: cdaValues,
                        backgroundColor: barColors.slice(0, cdaValues.length),
                        borderColor: barColors.slice(0, cdaValues.length).map(color => color.replace('0.6', '1')),
                        borderWidth: 1
                    },
                    {
                        label: 'Average CdA',
                        data: new Array(cdaValues.length).fill(averageCdA),
                        type: 'line',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2,
                        fill: false,
                        lineTension: 0,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Watts/CdA',
                        data: wattsPerCdaValues,
                        type: 'line',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 3,
                        fill: false,
                        lineTension: 0,
                        yAxisID: 'y1',
                        borderDash: [10, 5], // Add dashed line
                        pointBackgroundColor: 'rgba(54, 162, 235, 1)', // Add point markers
                        pointBorderColor: 'rgba(54, 162, 235, 1)',
                        pointRadius: 5
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true, 
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'CdA',
                            font: {
                                size: 16,
                                weight: 'bold',
                                family: 'Helvetica, Arial, sans-serif'
                            }
                        },
                        ticks: {
                            font: {
                                size: 14
                            },
                            stepSize: 0.025 // Set the step size to spread out the tick marks
                        }
                    },
                    y1: {
                        beginAtZero: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Watts/CdA (W/m²)',
                            font: {
                                size: 16,
                                weight: 'bold',
                                family: 'Helvetica, Arial, sans-serif'
                            }
                        },
                        ticks: {
                            font: {
                                size: 14
                            }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Test',
                            font: {
                                size: 16,
                                weight: 'bold',
                                family: 'Helvetica, Arial, sans-serif'
                            }
                        },
                        ticks: {
                            font: {
                                size: 14
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.dataset.label === 'Watts/CdA') {
                                    return `Watts/CdA: ${context.parsed.y}`;
                                }
                                return `CdA: ${context.parsed.y.toFixed(4)}`;
                            }
                        }
                    }
                }
            }
        });
    }
}


</script>

</body>
</html>
